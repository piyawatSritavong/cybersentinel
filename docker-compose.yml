version: "3.9"

services:
  cybersentinel-api:
    build:
      context: ./cybersentinel
      dockerfile: Dockerfile
    container_name: cybersentinel-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - APP_API_KEY=${APP_API_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_VAULT_KEY=${SECRET_VAULT_KEY:?SECRET_VAULT_KEY must be set}
      - ENABLE_SOCIAL_GATEWAY=${ENABLE_SOCIAL_GATEWAY:-false}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - MAX_QUEUE_SIZE=${MAX_QUEUE_SIZE:-1000}
    volumes:
      - sentinel-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
        reservations:
          memory: 512M
          cpus: "0.5"

  cybersentinel-dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: cybersentinel-dashboard
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      - NODE_ENV=production
      - APP_API_KEY=${APP_API_KEY}
      - SESSION_SECRET=${SESSION_SECRET:-change-me-in-production}
    depends_on:
      cybersentinel-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:5001/api/sentinel/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"

volumes:
  sentinel-data:
    driver: local
